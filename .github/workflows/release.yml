name: Release

on:
  workflow_dispatch:
    inputs:
      beta:
        description: 'Is beta release'
        required: true
        type: boolean
        default: false

permissions:
  contents: write
  actions: read
  pull-requests: read

jobs:
  setup:
    name: Setup
    runs-on: ubuntu-24.04
    outputs:
      version: ${{ steps.calculate.outputs.version }}
      last_version: ${{ steps.calculate.outputs.last_version }}
    steps:
      - name: Checkout Repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Get latest release version
        id: get_latest_release
        env:
          IS_BETA: ${{ inputs.beta }}
        run: |
          if [[ "$IS_BETA" == "true" ]]; then
            latest_version=$(git tag --sort=committerdate --list | tail -1)
          else
            latest_version=$(git tag --sort=committerdate --list | grep -v -- '-beta' | tail -1)
          fi
          echo "Latest version: $latest_version"
          echo "last_version=$latest_version" >> $GITHUB_OUTPUT

      - name: Determine release type
        id: get-release-type
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          LATEST_TAG: ${{ steps.get_latest_release.outputs.last_version }}
        run: |
          latest_tag=${{ steps.get_latest_release.outputs.last_version }}

          if [ -z "$latest_tag" ]; then
            echo "No tags found. Defaulting to minor for first release."
            echo "release_type=minor" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Latest tag: $latest_tag"

          # Get all commit messages since tag
          commit_msgs=$(git log "$latest_tag..HEAD" --format="%s")

          # Extract PR numbers.
          # Matches: "Merge pull request #123..." or "Commit message (#123)"
          pr_numbers=$(echo "$commit_msgs" | grep -oE '#[0-9]+' | tr -d '#' | sort -u)

          if [ -z "$pr_numbers" ]; then
            echo "No PRs found since $latest_tag. Defaulting to patch."
            echo "release_type=patch" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Found PRs: $pr_numbers"

          major=false
          minor=false

          for pr in $pr_numbers; do
            labels=$(gh pr view "$pr" --json labels -q '.labels[].name')
            echo "PR #$pr labels: $labels"
            if echo "$labels" | grep -q "version:major"; then
              major=true
            fi
            if echo "$labels" | grep -qE "version:minor|feat|feature"; then
              minor=true
            fi
          done

          if [ "$major" = "true" ]; then
            result="major"
          elif [ "$minor" = "true" ]; then
            result="minor"
          else
            result="patch"
          fi

          echo "release_type=$result" >> $GITHUB_OUTPUT

      - name: Calculate next version
        id: calculate
        env:
          VERSION_TYPE: ${{ steps.get-release-type.outputs.release_type }}
          IS_BETA: ${{ inputs.beta }}
        run: |
          echo -e "\nCalculating next version..."

          latest_version=$(git tag --sort=committerdate --list | tail -1)

          echo "  latest_version:  $latest_version"

          if [[ "$latest_version" == *"-beta"* ]]; then
              has_beta=true
              base_version=${latest_version%%-beta*}
              beta_suffix=${latest_version#*-beta}
              if [[ -z "$beta_suffix" ]]; then
                  beta_num=0
              else
                  beta_num=$beta_suffix
              fi
          else
              has_beta=false
              base_version=$latest_version
          fi

          latest_major_version=$(echo $base_version | cut -d "." -f 1)
          latest_minor_version=$(echo $base_version | cut -d "." -f 2)
          latest_patch_version=$(echo $base_version | cut -d "." -f 3)

          echo "  base_version: $base_version"

          if [[ "$VERSION_TYPE" == "major" ]]; then
              incremented_version="$(($latest_major_version + 1)).0.0"
          elif [[ "$VERSION_TYPE" == "minor" ]]; then
              incremented_version="${latest_major_version}.$(($latest_minor_version + 1)).0"
          elif [[ "$VERSION_TYPE" == "patch" ]]; then
              incremented_version="${latest_major_version}.${latest_minor_version}.$(($latest_patch_version + 1))"
          fi

          if [[ "$IS_BETA" == "true" ]]; then
              if [[ "$has_beta" == "true" ]]; then
                  next_beta_num=$((beta_num + 1))
                  next_version="${base_version}-beta${next_beta_num}"
              else
                  next_version="${incremented_version}-beta"
              fi
          else
              if [[ "$has_beta" == "true" ]]; then
                  next_version="${base_version}"
              else
                  next_version="${incremented_version}"
              fi
          fi

          echo "Next Version: $next_version"
          echo "version=$next_version" >> $GITHUB_OUTPUT

  build:
    name: Build
    uses: ./.github/workflows/_build.yml
    needs: setup
    with:
      release_version: ${{ needs.setup.outputs.version }}
    secrets: inherit

  draft-release:
    name: Create Draft Release
    runs-on: ubuntu-24.04
    needs:
      - setup
    steps:
      - name: Checkout Repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Build Changelog
        id: build_changelog
        uses: mikepenz/release-changelog-builder-action@439f79b5b5428107c7688c1d2b0e8bacc9b8792c # v6.0.1
        with:
          fromTag: ${{ needs.setup.outputs.last_version }}
          toTag: ${{ github.sha }}
          ignorePreReleases: ${{ !inputs.beta }}
          outputFile: changelog.md
          configurationJson: |
            {
              "template": "#{{CHANGELOG}}",
              "categories": [
                {
                    "title": "## ðŸš€ Features",
                    "labels": ["feat", "feature", "version:major", "version:minor"]
                },
                {
                    "title": "## ðŸ› Fixes",
                    "labels": ["fix", "bug", "bugfix", "version:patch"]
                }
              ],
              "ignore_labels": [
                "version:skip",
                "renovate",
                "dependencies",
                "skip-changelog"
              ],
              "empty_template": "Enhancements and bug fixes.",
              "pr_template": "- #{{TITLE}}"
            }

      - name: Output Changelog to github summary
        run: |
          echo "## Changelog" >> $GITHUB_STEP_SUMMARY
          cat changelog.md >> $GITHUB_STEP_SUMMARY

      - name: Create GitHub Draft Release
        uses: ncipollo/release-action@b7eabc95ff50cbeeedec83973935c8f306dfcd0b # v1.20.0
        if: github.ref_name == 'main'
        with:
          tag: ${{ needs.setup.outputs.version }}
          name: ${{ needs.setup.outputs.version }}
          bodyFile: changelog.md
          draft: true
          prerelease: ${{ inputs.beta }}

  approve-release:
    name: Approve Release
    needs:
      - draft-release
    if: github.ref_name == 'main'
    runs-on: ubuntu-24.04
    environment: 'production'
    steps:
      - name: Wait for approval
        run: |
          echo "Waiting for manual approval to proceed with the release..."

  release:
    name: Release
    needs:
      - setup
      - build
      - approve-release
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout Repo
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Download build artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: karoo-battery-estimator.apk

      - name: Download draft release body
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release view ${{ needs.setup.outputs.version }} --json body --template '{{.body}}' > changelog.md

      - name: Convert changelog to txt
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc
          pandoc changelog.md --from markdown-emoji -t plain -o changelog.txt

      - name: Get sha256 checksum
        id: checksum
        run: |
          sha256sum karoo-battery-estimator.apk | awk '{print $1}' > apk.sha256
          checksum=$(cat apk.sha256)
          echo "checksum=$checksum" >> $GITHUB_OUTPUT

      - name: Prepare manifest
        run: |
          chmod +x .github/scripts/prepare-manifest.sh
          ./.github/scripts/prepare-manifest.sh ${{ needs.setup.outputs.version }} ${{ github.run_number }} changelog.txt ${{ steps.checksum.outputs.checksum }}

      - name: Output manifest to a github step summary
        id: manifest
        run: |
          echo "## Manifest JSON" >> $GITHUB_STEP_SUMMARY
          cat manifest.json >> $GITHUB_STEP_SUMMARY

      - name: Publish Release
        uses: ncipollo/release-action@b7eabc95ff50cbeeedec83973935c8f306dfcd0b # v1.20.0
        if: github.ref_name == 'main'
        with:
          tag: ${{ needs.setup.outputs.version }}
          name: ${{ needs.setup.outputs.version }}
          allowUpdates: true
          draft: false
          prerelease: ${{ inputs.beta }}
          artifacts: |
            karoo-battery-estimator.apk
            manifest.json
            resources/karoo-battery-estimator-icon.png
            resources/camera-controls.png
